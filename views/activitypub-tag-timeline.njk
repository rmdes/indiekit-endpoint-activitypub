{% extends "layouts/ap-reader.njk" %}

{% from "prose/macro.njk" import prose with context %}

{% block readercontent %}
  {# Tag header #}
  <header class="ap-tag-header">
    <div class="ap-tag-header__info">
      <h2 class="ap-tag-header__title">#{{ tag }}</h2>
      <p class="ap-tag-header__count">
        {{ __("activitypub.reader.tagTimeline.postsTagged", items.length) }}
      </p>
    </div>
    <div class="ap-tag-header__actions">
      {% if isFollowed %}
        <form action="{{ mountPath }}/admin/reader/unfollow-tag" method="post" class="ap-tag-header__follow-form">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
          <input type="hidden" name="tag" value="{{ tag }}">
          <button type="submit" class="ap-tag-header__unfollow-btn">
            {{ __("activitypub.reader.tagTimeline.unfollowTag") }}
          </button>
        </form>
      {% else %}
        <form action="{{ mountPath }}/admin/reader/follow-tag" method="post" class="ap-tag-header__follow-form">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
          <input type="hidden" name="tag" value="{{ tag }}">
          <button type="submit" class="ap-tag-header__follow-btn">
            {{ __("activitypub.reader.tagTimeline.followTag") }}
          </button>
        </form>
      {% endif %}
      <a href="{{ mountPath }}/admin/reader" class="ap-tag-header__back">
        ← {{ __("activitypub.reader.title") }}
      </a>
    </div>
  </header>

  {# Timeline items #}
  {% if items.length > 0 %}
    <div class="ap-timeline"
      data-mount-path="{{ mountPath }}"
      data-tag="{{ tag }}"
      data-before="{{ before if before else '' }}">
      {% for item in items %}
        {% include "partials/ap-item-card.njk" %}
      {% endfor %}
    </div>

    {# Pagination (progressive enhancement fallback — hidden when infinite scroll JS active) #}
    {% if before or after %}
      <nav class="ap-pagination ap-pagination--js-hidden" id="ap-tag-pagination">
        {% if after %}
          <a href="?tag={{ tag }}&after={{ after }}" class="ap-pagination__prev">
            {{ __("activitypub.reader.pagination.newer") }}
          </a>
        {% endif %}
        {% if before %}
          <a href="?tag={{ tag }}&before={{ before }}" class="ap-pagination__next">
            {{ __("activitypub.reader.pagination.older") }}
          </a>
        {% endif %}
      </nav>
    {% endif %}

    {# Infinite scroll sentinel (Task 5) #}
    {% if before %}
      <div class="ap-load-more"
        id="ap-load-more"
        data-before="{{ before }}"
        data-tab=""
        data-tag="{{ tag }}"
        x-data="apInfiniteScroll()"
        x-init="init()"
        @ap-append-items.window="appendItems($event.detail)">
        <div class="ap-load-more__sentinel" x-ref="sentinel"></div>
        <button class="ap-load-more__btn" @click="loadMore()" :disabled="loading" x-show="!done">
          <span x-show="!loading">{{ __("activitypub.reader.pagination.loadMore") }}</span>
          <span x-show="loading">{{ __("activitypub.reader.pagination.loading") }}</span>
        </button>
        <p class="ap-load-more__done" x-show="done">{{ __("activitypub.reader.pagination.noMore") }}</p>
      </div>
    {% endif %}
  {% else %}
    {{ prose({ text: __("activitypub.reader.tagTimeline.noPosts", tag) }) }}
  {% endif %}
{% endblock %}
