{% extends "layouts/ap-reader.njk" %}

{% from "prose/macro.njk" import prose with context %}

{% block readercontent %}
  {# Page header #}
  <header class="ap-explore-header">
    <h2 class="ap-explore-header__title">{{ __("activitypub.reader.explore.title") }}</h2>
    <p class="ap-explore-header__desc">{{ __("activitypub.reader.explore.description") }}</p>
  </header>

  {# Tab navigation #}
  {% set exploreBase = mountPath + "/admin/reader/explore" %}
  <nav class="ap-tabs">
    <a href="{{ exploreBase }}" class="ap-tab{% if activeTab != 'decks' %} ap-tab--active{% endif %}">
      {{ __("activitypub.reader.explore.tabs.search") }}
    </a>
    <a href="{{ exploreBase }}?tab=decks" class="ap-tab{% if activeTab == 'decks' %} ap-tab--active{% endif %}">
      {{ __("activitypub.reader.explore.tabs.decks") }}
      {% if decks and decks.length > 0 %}
        <span class="ap-tab__count">{{ decks.length }}</span>
      {% endif %}
    </a>
  </nav>

  {# ── Search tab ────────────────────────────────────────────────── #}
  {% if activeTab != 'decks' %}

  {# Instance form with autocomplete #}
  <form action="{{ mountPath }}/admin/reader/explore" method="get" class="ap-explore-form"
    x-data="apInstanceSearch('{{ mountPath }}')"
    @submit="onSubmit">
    <div class="ap-explore-form__row">
      <div class="ap-explore-autocomplete">
        <input
          type="text"
          name="instance"
          value="{{ instance }}"
          class="ap-explore-form__input"
          placeholder="{{ __('activitypub.reader.explore.instancePlaceholder') }}"
          aria-label="{{ __('activitypub.reader.explore.instancePlaceholder') }}"
          autocomplete="off"
          required
          x-model="query"
          @input.debounce.300ms="search()"
          @keydown.arrow-down.prevent="highlightNext()"
          @keydown.arrow-up.prevent="highlightPrev()"
          @keydown.enter="selectHighlighted($event)"
          @keydown.escape="close()"
          @focus="showResults && suggestions.length > 0 ? showResults = true : null"
          @click.away="close()"
          x-ref="input">

        {# Autocomplete dropdown #}
        <div class="ap-explore-autocomplete__dropdown" x-show="showResults && suggestions.length > 0" x-cloak>
          <template x-for="(item, index) in suggestions" :key="item.domain">
            <button type="button"
              class="ap-explore-autocomplete__item"
              :class="{ 'ap-explore-autocomplete__item--highlighted': index === highlighted }"
              @click="selectItem(item)"
              @mouseenter="highlighted = index">
              <span class="ap-explore-autocomplete__domain" x-text="item.domain"></span>
              <span class="ap-explore-autocomplete__meta">
                <span class="ap-explore-autocomplete__software" x-text="item.software"></span>
                <template x-if="item.mau > 0">
                  <span class="ap-explore-autocomplete__mau" x-text="item.mau.toLocaleString() + ' {{ __("activitypub.reader.explore.mauLabel") }}'"></span>
                </template>
              </span>
              <span class="ap-explore-autocomplete__status" x-show="item._timelineStatus !== undefined">
                <template x-if="item._timelineStatus === 'checking'">
                  <span class="ap-explore-autocomplete__checking">⏳</span>
                </template>
                <template x-if="item._timelineStatus === true">
                  <span class="ap-explore-autocomplete__supported" title="{{ __('activitypub.reader.explore.timelineSupported') }}">✅</span>
                </template>
                <template x-if="item._timelineStatus === false">
                  <span class="ap-explore-autocomplete__unsupported" title="{{ __('activitypub.reader.explore.timelineUnsupported') }}">❌</span>
                </template>
              </span>
            </button>
          </template>
        </div>
      </div>

      <div class="ap-explore-form__scope">
        <label class="ap-explore-form__scope-label">
          <input type="radio" name="scope" value="local"
            {% if scope == "local" %}checked{% endif %}>
          {{ __("activitypub.reader.explore.local") }}
        </label>
        <label class="ap-explore-form__scope-label">
          <input type="radio" name="scope" value="federated"
            {% if scope == "federated" %}checked{% endif %}>
          {{ __("activitypub.reader.explore.federated") }}
        </label>
      </div>
      <button type="submit" class="ap-explore-form__btn">
        {{ __("activitypub.reader.explore.browse") }}
      </button>
    </div>
  </form>

  {# Error state #}
  {% if error %}
    <div class="ap-explore-error">{{ error }}</div>
  {% endif %}

  {# Results #}
  {% if instance and not error %}
    {# Add to deck toggle button (shown when browsing results) #}
    {% if items.length > 0 %}
      <div class="ap-explore-deck-toggle"
        x-data="apDeckToggle('{{ instance }}', '{{ scope }}', '{{ mountPath }}', '{{ csrfToken }}', {{ deckCount }}, {{ 'true' if isInDeck else 'false' }})">
        <button
          type="button"
          class="ap-explore-deck-toggle__btn"
          :class="{ 'ap-explore-deck-toggle__btn--active': inDeck }"
          @click="toggle()"
          :disabled="!inDeck && deckLimitReached"
          :title="!inDeck && deckLimitReached ? '{{ __('activitypub.reader.explore.deck.deckLimitReached') }}' : (inDeck ? '{{ __('activitypub.reader.explore.deck.removeFromDeck') }}' : '{{ __('activitypub.reader.explore.deck.addToDeck') }}')"
          :aria-label="!inDeck && deckLimitReached ? '{{ __('activitypub.reader.explore.deck.deckLimitReached') }}' : (inDeck ? '{{ __('activitypub.reader.explore.deck.removeFromDeck') }}' : '{{ __('activitypub.reader.explore.deck.addToDeck') }}')"
          x-text="inDeck ? '★ {{ __('activitypub.reader.explore.deck.inDeck') }}' : '☆ {{ __('activitypub.reader.explore.deck.addToDeck') }}'">
        </button>
      </div>
    {% endif %}

    {% if items.length > 0 %}
      <div class="ap-timeline ap-explore-timeline"
        id="ap-explore-timeline"
        data-instance="{{ instance }}"
        data-scope="{{ scope }}"
        data-mount-path="{{ mountPath }}"
        data-max-id="{{ maxId if maxId else '' }}">
        {% for item in items %}
          {% include "partials/ap-item-card.njk" %}
        {% endfor %}
      </div>

      {# Infinite scroll for explore page #}
      {% if maxId %}
        <div class="ap-load-more"
          id="ap-explore-load-more"
          data-max-id="{{ maxId }}"
          data-instance="{{ instance }}"
          data-scope="{{ scope }}"
          x-data="apExploreScroll()"
          x-init="init()">
          <div class="ap-load-more__sentinel" x-ref="sentinel"></div>
          <button class="ap-load-more__btn" @click="loadMore()" :disabled="loading" x-show="!done">
            <span x-show="!loading">{{ __("activitypub.reader.pagination.loadMore") }}</span>
            <span x-show="loading">{{ __("activitypub.reader.pagination.loading") }}</span>
          </button>
          <p class="ap-load-more__done" x-show="done" x-cloak>{{ __("activitypub.reader.pagination.noMore") }}</p>
        </div>
      {% endif %}
    {% elif instance %}
      {{ prose({ text: __("activitypub.reader.explore.noResults") }) }}
    {% endif %}
  {% endif %}

  {% endif %}{# end Search tab #}

  {# ── Decks tab ──────────────────────────────────────────────────── #}
  {% if activeTab == 'decks' %}
    {% if decks and decks.length > 0 %}
      <div class="ap-deck-grid" data-csrf-token="{{ csrfToken }}">
        {% for deck in decks %}
          <div class="ap-deck-column"
            x-data="apDeckColumn('{{ deck.domain }}', '{{ deck.scope }}', '{{ mountPath }}', {{ loop.index0 }}, '{{ csrfToken }}')"
            x-init="init()">
            <header class="ap-deck-column__header">
              <span class="ap-deck-column__domain">{{ deck.domain }}</span>
              <span class="ap-deck-column__scope-badge ap-deck-column__scope-badge--{{ deck.scope }}">
                {{ __("activitypub.reader.explore.deck." + deck.scope + "Badge") }}
              </span>
              <button
                type="button"
                class="ap-deck-column__remove"
                @click="removeDeck()"
                title="{{ __('activitypub.reader.explore.deck.removeColumn') }}"
                aria-label="{{ __('activitypub.reader.explore.deck.removeColumn') }}">×</button>
            </header>
            <div class="ap-deck-column__body" x-ref="body">
              <div x-show="loading && itemCount === 0" class="ap-deck-column__loading">
                <span>{{ __("activitypub.reader.pagination.loading") }}</span>
              </div>
              <div x-show="error" class="ap-deck-column__error" x-cloak>
                <p x-text="error"></p>
                <button type="button" class="ap-deck-column__retry" @click="retryLoad()">
                  {{ __("activitypub.reader.explore.deck.retry") }}
                </button>
              </div>
              <div x-show="!loading && !error && itemCount === 0" class="ap-deck-column__empty" x-cloak>
                {{ __("activitypub.reader.explore.noResults") }}
              </div>
              <div x-html="html" class="ap-deck-column__items"></div>
              <div class="ap-deck-column__sentinel" x-ref="sentinel"></div>
              <div x-show="loading && itemCount > 0" class="ap-deck-column__loading-more" x-cloak>
                <span>{{ __("activitypub.reader.pagination.loading") }}</span>
              </div>
              <p x-show="done && itemCount > 0" class="ap-deck-column__done" x-cloak>
                {{ __("activitypub.reader.pagination.noMore") }}
              </p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="ap-deck-empty">
        <p>{{ __("activitypub.reader.explore.deck.emptyState") }}</p>
        <a href="{{ exploreBase }}" class="ap-deck-empty__link">
          {{ __("activitypub.reader.explore.deck.emptyStateLink") }}
        </a>
      </div>
    {% endif %}
  {% endif %}{# end Decks tab #}

{% endblock %}
